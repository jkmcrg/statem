<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Guide | StateM</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/statem/assets/css/0.styles.9cb8d412.css" as="style"><link rel="preload" href="/statem/assets/js/app.3c669fc2.js" as="script"><link rel="preload" href="/statem/assets/js/7.f5c78133.js" as="script"><link rel="preload" href="/statem/assets/js/3.6da4c649.js" as="script"><link rel="prefetch" href="/statem/assets/js/2.3db63443.js"><link rel="prefetch" href="/statem/assets/js/4.aae7ce55.js"><link rel="prefetch" href="/statem/assets/js/5.3625c0a6.js"><link rel="prefetch" href="/statem/assets/js/6.d641596f.js">
    <link rel="stylesheet" href="/statem/assets/css/0.styles.9cb8d412.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/statem/" class="home-link router-link-exact-active router-link-active"><!----> <span class="site-name">StateM</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/statem/" class="nav-link router-link-exact-active router-link-active">Home</a></div><div class="nav-item"><a href="/statem/demo/" class="nav-link">Demo</a></div><div class="nav-item"><a href="https://github.com/venkatperi/statem" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/statem/" class="nav-link router-link-exact-active router-link-active">Home</a></div><div class="nav-item"><a href="/statem/demo/" class="nav-link">Demo</a></div><div class="nav-item"><a href="https://github.com/venkatperi/statem" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/statem/" class="active sidebar-link">Guide</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/statem/#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/statem/#state-machines" class="sidebar-link">State Machines</a></li><li class="sidebar-sub-header"><a href="/statem/#statem" class="sidebar-link">StateM</a></li></ul></li><li class="sidebar-sub-header"><a href="/statem/#installation" class="sidebar-link">Installation</a></li><li class="sidebar-sub-header"><a href="/statem/#usage" class="sidebar-link">Usage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/statem/#subclassing-statemachine" class="sidebar-link">Subclassing StateMachine</a></li><li class="sidebar-sub-header"><a href="/statem/#in-the-browser" class="sidebar-link">In the Browser</a></li><li class="sidebar-sub-header"><a href="/statem/#react-state-management" class="sidebar-link">React State Management</a></li></ul></li><li class="sidebar-sub-header"><a href="/statem/#how-it-works" class="sidebar-link">How It Works</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/statem/#routes" class="sidebar-link">Routes</a></li><li class="sidebar-sub-header"><a href="/statem/#event-handlers" class="sidebar-link">Event Handlers</a></li><li class="sidebar-sub-header"><a href="/statem/#result-builder" class="sidebar-link">Result Builder</a></li><li class="sidebar-sub-header"><a href="/statem/#mutating-state-machine-data" class="sidebar-link">Mutating State Machine Data</a></li><li class="sidebar-sub-header"><a href="/statem/#event-types" class="sidebar-link">Event Types</a></li><li class="sidebar-sub-header"><a href="/statem/#processing-events" class="sidebar-link">Processing Events</a></li></ul></li><li class="sidebar-sub-header"><a href="/statem/#examples-2" class="sidebar-link">Examples</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/statem/#toggle-button-with-count" class="sidebar-link">Toggle Button With Count</a></li><li class="sidebar-sub-header"><a href="/statem/#push-button-countdown-timer" class="sidebar-link">Push Button Countdown Timer</a></li><li class="sidebar-sub-header"><a href="/statem/#a-hotel-safe" class="sidebar-link">A Hotel Safe</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p><strong>statem</strong> is a JavaScript state/turing machine framework which lets you manage your application's <em>total state</em> (i.e. named states, transitions, data, and rewriting of inputs).</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>StateM is largely based on Erlang OTP’s <a href="http://erlang.org/doc/design_principles/statem.html" title="gen_statem" target="_blank" rel="noopener noreferrer">gen_statem<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> behavior.</p></div> <h3 id="state-machines"><a href="#state-machines" class="header-anchor">#</a> State Machines</h3> <p>State machines are ideal for programming tasks that involve a) a sequence of operations and b) logic that dictates which operation will be executed after the current one based, for example, on data you’re managing, inputs from the user, responses from pending tasks and timeouts.</p> <p>Most implementations of state machines are without memory (also known as Deterministric Finite Automata) and can manage an app's <em>named state</em> and transitions between them (e.g. idle, running, loaded, error).</p> <p>State machine implementations are usually structured as a forest of trees, with states as root nodes, inputs/transitions as intermediate nodes, handlers and actions as leaf nodes. Inputs are handled by walking down the tree from the root of node of current state.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>A tree specification can grow very quickly as the number of states and events increase.</p></div> <h3 id="statem"><a href="#statem" class="header-anchor">#</a> StateM</h3> <p>In contrast, <em>statem</em> provides management of <em>total state</em>, i.e.:</p> <ul><li>Management of states and transitions as in a DFA,</li> <li>Custom read/write memory available to handlers,</li> <li>Ability to rewrite inputs by postponing them.</li></ul> <p><em>statem</em> uses a flat list with composite keys of <em>event + state</em> and pattern matching on keys collapses the search space.</p> <p>State machines are specified as an ordered list of handlers keyed by <code>Event x State</code> patterns. Events drive the state machine and are externally triggered or internally generated by the state machine. Pending events are tracked on a priority queue that preserves entry order. State machines can hold arbitrary <a href="#">data</a> which is provided to, and can be mutated by, its event handlers.</p> <h4 id="features"><a href="#features" class="header-anchor">#</a> Features</h4> <ul><li><strong>Co-located code</strong>: Event, states, transitions and actions in one place.</li> <li><strong>Inserted Events</strong>: Insert events from within the specification.</li> <li><strong>State Entry Events</strong>: Automatically generates Entry events on state change.</li> <li><strong>Timeouts</strong>: Install timeouts for state transitions, new events, or just plain timeouts.</li></ul> <h2 id="installation"><a href="#installation" class="header-anchor">#</a> Installation</h2> <p>Install with <code>npm</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save gen-statem
</code></pre></div><h2 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h2> <p>Create a state machine by calling <code>StateMachine's</code> constructor and passing it a list of handlers, the initial state and optional data.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The state machine’s data type <code>TData</code> is a type argument (<code>StateMachine&lt;TData&gt;</code>).</p></div> <p>For example, the state machine below toggles states <code>ONE</code> and <code>TWO</code> on event <code>next</code>. <img src="https://documents.lucidchart.com/documents/eef39cb2-9656-4c52-88d8-eb6c9f6a5cec/pages/YGcM5DNywbTK?a=1152&amp;x=85&amp;y=151&amp;w=360&amp;h=181&amp;store=1&amp;accept=image/*&amp;auth=LCA%20a77efaa9c861072b1008c96fd065a7b008f5aa33-ts=1538363749" alt=""></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> sm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StateMachine</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    handlers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string">'cast#next#ONE'</span><span class="token punctuation">,</span> <span class="token string">'TWO'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'cast#next#TWO'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">nextState</span><span class="token punctuation">(</span><span class="token string">'ONE'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    initialState<span class="token punctuation">:</span> <span class="token string">&quot;ONE&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
sm<span class="token punctuation">.</span><span class="token function">startSM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sm<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stateChanged'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> old<span class="token punctuation">,</span> data<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>old<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --&gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> on </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event <span class="token operator">?</span> event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sm<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span> <span class="token comment">// ONE --&gt; TWO on Cast@Low { context: 'next' }</span>
sm<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span> <span class="token comment">// TWO --&gt; ONE on Cast@Low { context: 'next' }</span>
</code></pre></div><h3 id="subclassing-statemachine"><a href="#subclassing-statemachine" class="header-anchor">#</a> Subclassing StateMachine</h3> <p>Extending the <code>StateMachine</code> class lets you declare and implement a public API for your state machine (and wrap call/cast dispatch calls).</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Handler functions are called with <code>this</code> set to the state machine instance.</p></div> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">PingPong</span> <span class="token keyword">extends</span> <span class="token class-name">StateMachine</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    handlers<span class="token punctuation">:</span> Handlers<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string">'cast#next#ONE'</span><span class="token punctuation">,</span> <span class="token string">'TWO'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'cast#next#TWO'</span><span class="token punctuation">,</span> <span class="token string">'ONE'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
    initialState <span class="token operator">=</span> <span class="token string">&quot;ONE&quot;</span>
    <span class="token comment">// Define our public API</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> sm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PingPong</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sm<span class="token punctuation">.</span><span class="token function">startSM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sm<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stateChanged'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> old<span class="token punctuation">,</span> data<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>old<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --&gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> on </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event <span class="token operator">?</span> event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sm<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// ONE --&gt; TWO on Cast@Low { context: 'next' }</span>
sm<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// TWO --&gt; ONE on Cast@Low { context: 'next' }</span>
</code></pre></div><h3 id="in-the-browser"><a href="#in-the-browser" class="header-anchor">#</a> In the Browser</h3> <p>Fetch it from npm via unpkg:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/gen-statem/dist/umd/gen-statem.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="react-state-management"><a href="#react-state-management" class="header-anchor">#</a> React State Management</h3> <p>StateM accepts a <code>DataProxy</code> object to synchronize its internal data with external objects such as React components.</p> <blockquote><p>Terminology: State machine data == React component state</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StateMachine</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>
      dataProxy<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token punctuation">(</span> <span class="token parameter">data<span class="token punctuation">,</span> state</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token operator">...</span>data<span class="token punctuation">,</span> currentState<span class="token punctuation">:</span> state <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="how-it-works"><a href="#how-it-works" class="header-anchor">#</a> How It Works</h2> <h3 id="routes"><a href="#routes" class="header-anchor">#</a> Routes</h3> <p>StateM uses the url path to parameterized route matching seen in <a href="www.expressjs.com">express</a> et. al.</p> <h4 id="current-event-routes"><a href="#current-event-routes" class="header-anchor">#</a> Current Event Routes</h4> <p>The current event and current state are mapped to a route string as:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;current event&gt;#&lt;event context&gt;#&lt;current state&gt;
</code></pre></div><p>For example:</p> <table><thead><tr><th>Event</th> <th>Event Context</th> <th>Current State</th> <th>Route</th></tr></thead> <tbody><tr><td>cast</td> <td><code>&quot;flip&quot;</code></td> <td>off</td> <td><code>&quot;cast#flip#off&quot;</code></td></tr> <tr><td>cast</td> <td><code>{button: 2}</code></td> <td>locked</td> <td><code>&quot;cast#button/2#off&quot;</code></td></tr> <tr><td>call</td> <td><code>&quot;getInfo&quot;</code></td> <td>one</td> <td><code>&quot;call/internalId#getInfo/2#one&quot;</code></td></tr></tbody></table> <h4 id="event-handler-routes"><a href="#event-handler-routes" class="header-anchor">#</a> Event Handler Routes</h4> <p>In addition to string literals, handler routes can include:</p> <ul><li>Parameter capture patterns (<code>:param</code>) capture up to the next <code>/</code>, <code>#</code> or the end of the route.</li> <li>Splats (<code>*param</code>) capture from up to <code>#</code> or the end of the route.</li> <li>Parts of the route can be marked optional by wrapping in parenthesis. Optional parts can include parameter capture and splats.</li></ul> <h5 id="examples"><a href="#examples" class="header-anchor">#</a> Examples</h5> <ul><li><code>cast#flip#:state</code> will match a <code>cast(flip)</code> event in any state and provide the current state as an argument (<code>args.param</code>) to the handler.</li> <li><code>call/:from#getInfo#:state</code> will capture the callerId and state as <code>args.from</code> and <code>args.state</code> respectively.</li> <li><code>&quot;cast#button/:digit#locked</code> will capture a button press in the <code>locked</code> state and provide the digit value in <code>args.digit</code>.</li> <li><code>&quot;cast#*context#open</code> intercepts any <code>cast</code> events in state <code>open</code> regardless of the parameters passed when cast was invoked (note: the splat will be available as <code>args.context</code>).</li></ul> <h3 id="event-handlers"><a href="#event-handlers" class="header-anchor">#</a> Event Handlers</h3> <p>A key part of a state machine specification is the list of (route, handler) tuples:</p> <div class="language- extra-class"><pre class="language-text"><code>(string | Array&lt;string&gt;, function | string | [string, string | number])
</code></pre></div><blockquote><p>Note: Event handlers are specified as an array to preserve order (vs. objects, where property<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...in#Deleted_added_or_modified_properties" target="_blank" rel="noopener noreferrer">iteration order<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is arbitrary).</p></blockquote> <h4 id="multiple-routes-to-a-handler"><a href="#multiple-routes-to-a-handler" class="header-anchor">#</a> Multiple Routes to a Handler</h4> <p>When a route is specified as an array, it is treated as a boolean OR, i.e. if any route matches an incoming event route, the corresponding handler is invoked.</p> <h4 id="handler-functions"><a href="#handler-functions" class="header-anchor">#</a> Handler Functions</h4> <p>Handler functions receive the following:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> HandlerOpts<span class="token operator">&lt;</span>TData<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    args<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>k <span class="token keyword">in</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    current<span class="token punctuation">:</span> State<span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> TData<span class="token punctuation">,</span>
    event<span class="token punctuation">:</span> Event<span class="token punctuation">,</span>
    route<span class="token punctuation">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>current</code>: the state machine’s current state.</li> <li><code>data</code>: the state machine’s current data.</li> <li><code>args</code>: any arguments or splats parsed from the incoming event’s route.</li> <li><code>event</code>: the actual incoming event.</li> <li><code>route</code>: the event’s route.</li></ul> <p>Handler functions can return:</p> <ul><li><code>ResultBuilder</code> a fluent builder for <code>Results</code>.</li> <li><code>Result</code> - verbose, not recommended.</li> <li><code>void</code> - interpreted as <code>keepStateAndData</code></li></ul> <h4 id="string-handlers"><a href="#string-handlers" class="header-anchor">#</a> <code>string</code> Handlers</h4> <p>Instead of a handler function, you can provide a</p> <ul><li><code>state: string</code> - interpreted as a next state directive.</li> <li><code>[state: string, timeout: string | number]</code> - interpreted as a next state directive and event timeout.</li></ul> <h3 id="result-builder"><a href="#result-builder" class="header-anchor">#</a> Result Builder</h3> <p>StateM provides a fluent interface (<code>ResultBuilder</code>) for specifying state transitions and actions in handler functions.</p> <p>The following functions return a <code>ResultBuilder</code>:</p> <ul><li><a href="#">keepState</a>: Instructs the state machine to keep the current state (i.e. transition to the same state). Does not emit a state entry event.</li> <li><a href="#">repeatState</a>: Like <code>keepState</code>, but emits a state entry event.</li> <li><a href="#">nextState(state)</a>: Instructs the state machine to transition to the given <code>state</code> (can be the current state).</li></ul> <h4 id="resultbuilder-methods"><a href="#resultbuilder-methods" class="header-anchor">#</a> ResultBuilder Methods</h4> <p><code>ResultBuilders</code> provide the following chainable methods:</p> <ul><li><a href="#">data(spec)</a>: Instructs the state machine to mutate state data with the given <code>spec</code>.</li> <li><a href="#">eventTimeout(time)</a>: Starts the event timer which may result in a <code>EventTimeoutEvent</code> event if a new event is not received.</li> <li><a href="#">stateTimeout(time)</a>: Starts the state timer which may result in a <code>StateTimeoutEvent</code> event if a state transition does not occur.</li> <li><a href="#">timeout(time, name)</a>: Starts a generic timer with an optional name which may result in a <code>GenericTimeoutEvent</code>. Calling <code>timeout(name)</code> will cancel the event if it has not yet fired.</li> <li><a href="#">nextEvent(type, context, extra)</a>: Inserts an event of the given type at the front of the queue so that it is executed before pending events.</li> <li><a href="#">internalEvent(context, extra)</a>: Like <code>nextEvent</code>, this method inserts an <code>InternalEvent</code> event.</li> <li><a href="#">postpone</a>: Instructs the state machine to postpone the current until the state changes at which point any postponed events are delivered before pending events.</li> <li><a href="#">reply(from, msg)</a>: Instructs the state machine to reply to the sender with id <code>from</code>; the result of a prior invocation of <code>call</code>.</li></ul> <h3 id="mutating-state-machine-data"><a href="#mutating-state-machine-data" class="header-anchor">#</a> Mutating State Machine Data</h3> <p>State machine data is mutated by calling the <code>data</code> on <code>ResultBuilder</code> with <a href="#">immutability-helper</a> commands, including:</p> <ul><li><code>{$push: array}</code> <code>push()</code> all the items in <code>array</code> on the target.
<ul><li><code>{$unshift: array}</code> <code>unshift()</code> all the items in <code>array</code> on the target.</li> <li><code>{$splice: array of arrays}</code> for each item in <code>arrays</code> call <code>splice()</code> on the target with the parameters provided by the item. Note: The items in the array are applied sequentially, so the order matters. The indices of the target may change during the operation.* * <code>{$set: any}</code> replace the target entirely.</li> <li><code>{$toggle: array of strings}</code> toggles a list of boolean fields from the target object.</li> <li><code>{$unset: array of strings}</code> remove the list of keys in <code>array</code> from the target object.</li> <li><code>{$merge: object}</code> merge the keys of <code>object</code> with the target.</li> <li><code>{$apply: function}</code> passes in the current value to the function and updates it with the new returned value.</li> <li><code>{$add: array of objects}</code> add a value to a <code>Map</code> or <code>Set</code>. When adding to a <code>Set</code> you pass in an array of objects to add, when adding to a Map, you pass in <code>[key, value]</code> arrays like so: <code>update(myMap, {$add: [['foo', 'bar'], ['baz', 'boo']]})</code></li> <li><code>{$remove: array of strings}</code> remove the list of keys in array from a <code>Map</code> or <code>Set</code>.</li></ul></li></ul> <h3 id="event-types"><a href="#event-types" class="header-anchor">#</a> Event Types</h3> <h4 id="callevent"><a href="#callevent" class="header-anchor">#</a> CallEvent</h4> <p>Sends a event of type <code>call</code> to the state machine and returns a pending Promise.
*   Call <code>call(context, extra)</code> to emit.
*   Event handlers can reply with <code>reply()</code> action which resolves the pending Promise returned by <code>call()</code>.
*   Internally, call generates a <code>from</code> id to identify the caller.
*   The event route for call is: <code>call/&lt;from&gt;#&lt;context&gt;#&lt;state&gt;</code>.</p> <h4 id="castevent"><a href="#castevent" class="header-anchor">#</a> CastEvent</h4> <p>Sends a event of type <code>cast</code> to the state machine and returns without waiting for a result.
*   Call <code>cast(context, extra)</code> to emit.
*   The event route for cast is: <code>cast#&lt;context&gt;#&lt;state&gt;</code>.</p> <h4 id="enterevent"><a href="#enterevent" class="header-anchor">#</a> EnterEvent</h4> <p>Sends a <code>enter</code> event to the state machine.
*   Internally generated by the state machine on a state transition. If the state machine is transitioning to the same state, <code>enter</code> is emitted if the previous event handler returns <code>repeatState</code> (and not for either of <code>keepState</code>, or <code>nextState(same state)</code>).</p> <h4 id="eventtimeoutevent"><a href="#eventtimeoutevent" class="header-anchor">#</a> EventTimeoutEvent</h4> <p>Sends a <code>eventTimeout</code> event to the state machine.
*   Internally generated by the state machine when the eventTimeout timer fires.
*   The eventTimeout timer is started by invoking <code>eventTimeout(timeout)</code> in a event handler.
*   The event route for <code>eventTimeout</code> is: <code>eventTimeout#&lt;context&gt;#&lt;state&gt;</code>.
*   Can be cancelled by calling <code>eventTimeout()</code> without a timeout argument from an event handler.</p> <h4 id="generictimeoutevent"><a href="#generictimeoutevent" class="header-anchor">#</a> GenericTimeoutEvent</h4> <p>Sends a <code>genericTimeout</code> event to the state machine.
*   Internally generated by the state machine when the (optionally named) genericTimeout timer fires.
*   A genericTimeout timer is started by invoking <code>genericTimeout(timeout [, name])</code> in a event handler.
*   The event route for <code>genericTimeout</code> is: <code>genericTimeout#&lt;context&gt;#&lt;state&gt;</code>.
*   Can be cancelled by calling <code>genericTimeout([name])</code> without a timeout argument from an event handler.</p> <h4 id="statetimeoutevent"><a href="#statetimeoutevent" class="header-anchor">#</a> StateTimeoutEvent</h4> <p>Sends a <code>stateTimeout</code> event to the state machine.
*   Internally generated by the state machine when the stateTimeout timer fires.
*   The stateTimeout timer is started by invoking <code>stateTimeout(timeout)</code> in a event handler.
*   The event route for <code>stateTimeout</code> is: <code>stateTimeout#&lt;context&gt;#&lt;state&gt;</code>.
*   Can be cancelled by calling <code>stateTimeout()</code> without arguments from an event handler.</p> <h4 id="internalevent"><a href="#internalevent" class="header-anchor">#</a> InternalEvent</h4> <p>Sends a <code>internal</code> event to the state machine. This is a deliberately named event to let the state machine know that the event is internal.
*   Internally generated by invoking <code>internal(context, extra)</code> from a event handler.
*   The event route for <code>internal</code> is: <code>internal#&lt;context&gt;#&lt;state&gt;</code>.</p> <h3 id="processing-events"><a href="#processing-events" class="header-anchor">#</a> Processing Events</h3> <p>The state machine looks for the first event handler whose key matches the <code>incoming event x current state</code>, or, a catch-all handler.</p> <p>The matched handler is invoked with the incoming event, route matching arguments, the current state machine state and data.</p> <p>The result of the handler invocation can include a state transition directive and transition actions, which are immediately executed, potentially changing the state machine’s state, mutating the internal data as well as the event queue.</p> <h2 id="examples-2"><a href="#examples-2" class="header-anchor">#</a> Examples</h2> <p>See the <code>examples</code> directory for more examples.</p> <h3 id="toggle-button-with-count"><a href="#toggle-button-with-count" class="header-anchor">#</a> Toggle Button With Count</h3> <p>ToggleButtonCount maintains a counter in the state machine’s data that counts the number of times it turned on.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> ToggleButtonWithCountData <span class="token operator">=</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token builtin">number</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ToggleButtonWithCount</span>
    <span class="token keyword">extends</span> <span class="token class-name">StateMachine</span><span class="token operator">&lt;</span>ToggleButtonWithCountData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    initialState <span class="token operator">=</span> <span class="token string">'off'</span>

    handlers<span class="token punctuation">:</span> Handlers<span class="token operator">&lt;</span>ToggleButtonWithCountData<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment">// if we get 'flip' in 'off', go to 'on'</span>
        <span class="token comment">// and increment data.count</span>
        <span class="token punctuation">[</span><span class="token string">'cast#flip#off'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">nextState</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">{</span>count<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> data<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// flip from on goes back to off.</span>
        <span class="token punctuation">[</span><span class="token string">'cast#flip#on'</span><span class="token punctuation">,</span> <span class="token string">'off'</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>

    initialData<span class="token punctuation">:</span> ToggleButtonWithCountData <span class="token operator">=</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'flip'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> button <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToggleButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
button<span class="token punctuation">.</span><span class="token function">startSM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// initial state</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> button<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 'off'</span>

button<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> button<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 'on'</span>

button<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> button<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 'off'</span>
</code></pre></div><h3 id="push-button-countdown-timer"><a href="#push-button-countdown-timer" class="header-anchor">#</a> Push Button Countdown Timer</h3> <p>PushButtonCountdownTimer turns on when pushed and starts a <code>genericTimeout</code>. The button turns off when the timer fires.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> PushButtonCountdownTimerData <span class="token operator">=</span> <span class="token punctuation">{</span>
    timeout<span class="token punctuation">:</span> Timeout
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PushButtonCountdownTimer</span> <span class="token keyword">extends</span> <span class="token class-name">StateMachine</span><span class="token operator">&lt;</span>PushButtonCountdownTimerData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    initialState <span class="token operator">=</span> <span class="token string">'off'</span>

    handlers<span class="token punctuation">:</span> Handlers<span class="token operator">&lt;</span>PushButtonCountdownTimerData<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment">// Start a generic timer and go to 'on'</span>
        <span class="token punctuation">[</span><span class="token string">'cast#push#off'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">nextState</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// when we get 'genericTimeout' in 'on',</span>
        <span class="token comment">// go back to 'off'</span>
        <span class="token punctuation">[</span><span class="token string">'genericTimeout#*_#on'</span><span class="token punctuation">,</span> <span class="token string">'off'</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">timeout<span class="token punctuation">:</span> Timeout</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>initialData <span class="token operator">=</span> <span class="token punctuation">{</span>timeout<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="a-hotel-safe"><a href="#a-hotel-safe" class="header-anchor">#</a> A Hotel Safe</h3> <p>See <a href="https://hotel-safe.netlify.com/#/" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/badge/demo-online-green.svg" alt=""><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <code>HotelSafe</code> simulates a type of safe frequently seen in hotel rooms.</p> <ul><li><p><strong>Locking the Safe</strong></p> <ul><li>Press Reset (R). The display will prompt for a new code.</li> <li>Enter a 4 digit code and then press Lock (L).</li> <li>The code will flash. The safe is now locked.</li></ul></li> <li><p><strong>Unlocking the Safe</strong></p> <ul><li>Enter the 4 digit code.</li> <li>The safe will flash OPENED if the code is correct. The safe is now open.</li> <li>If the code is incorrect, the display will flash ERROR and the safe will stay locked.</li></ul></li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * The state machine's data type
 */</span>
<span class="token keyword">type</span> SafeData <span class="token operator">=</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    input<span class="token punctuation">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    timeout<span class="token punctuation">:</span> Timeout<span class="token punctuation">,</span>
    codeSize<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
    message<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">HotelSafe</span> <span class="token keyword">extends</span> <span class="token class-name">StateMachine</span><span class="token operator">&lt;</span>SafeData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    handlers<span class="token punctuation">:</span> Handlers<span class="token operator">&lt;</span>SafeData<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span>

        <span class="token comment">// Clear data when safe enters OPEN</span>
        <span class="token punctuation">[</span><span class="token string">'enter#*_#open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">keepState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            code<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            input<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            message<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token string">'Open'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// User pressed RESET -- get new code</span>
        <span class="token punctuation">[</span><span class="token string">'cast#reset#open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">nextState</span><span class="token punctuation">(</span><span class="token string">'open/locking'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            message<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token string">'Enter Code'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// Track the last {codeSize} digits.</span>
        <span class="token comment">// show code on display. Repeat state for setting timeout</span>
        <span class="token punctuation">[</span><span class="token string">'cast#button/:digit#open/locking'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>args<span class="token punctuation">,</span> data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token function">pushFixed</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>digit<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>code<span class="token punctuation">,</span> data<span class="token punctuation">.</span>codeSize<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">repeatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                code<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> code<span class="token punctuation">}</span><span class="token punctuation">,</span>
                message<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> code<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// User pressed LOCK. CLose safe if code is long enough</span>
        <span class="token comment">// else, repeat state (sets timeout on reentry)</span>
        <span class="token punctuation">[</span><span class="token string">'cast#lock#open/locking'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            data<span class="token punctuation">.</span>code<span class="token punctuation">.</span>length <span class="token operator">!==</span> data<span class="token punctuation">.</span>codeSize <span class="token operator">?</span>
            <span class="token function">repeatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
            <span class="token function">nextState</span><span class="token punctuation">(</span><span class="token string">'closed/success'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                message<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>code<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// Clear input when safe is closed</span>
        <span class="token punctuation">[</span><span class="token string">'enter#*_#closed'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">keepState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            input<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            message<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token string">'Locked'</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// Postpone button press and go to closed/unlocking</span>
        <span class="token punctuation">[</span><span class="token string">'cast#button/*_#closed'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token function">nextState</span><span class="token punctuation">(</span><span class="token string">'closed/unlocking'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postpone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// User entered digit(s).</span>
        <span class="token operator">/</span><span class="token operator">/</span> Keep state <span class="token keyword">if</span> code <span class="token keyword">is</span> not long enough
        <span class="token operator">/</span><span class="token operator">/</span> <span class="token constant">OPEN</span> <span class="token keyword">if</span> input matches code
        <span class="token operator">/</span><span class="token operator">/</span> go to <span class="token constant">MESSAGE</span> <span class="token keyword">if</span> code does not match and <span class="token keyword">set</span> a timeout
        <span class="token punctuation">[</span><span class="token string">'cast#button/:digit#closed/unlocking'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>args<span class="token punctuation">,</span> data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> digit <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>digit<span class="token punctuation">)</span>
            <span class="token keyword">let</span> input <span class="token operator">=</span> data<span class="token punctuation">.</span>input<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>digit<span class="token punctuation">)</span>

            <span class="token operator">/</span><span class="token operator">/</span> code <span class="token keyword">is</span> the correct length<span class="token punctuation">.</span> Decision time<span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> data<span class="token punctuation">.</span>code<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> msg<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">arrayEqual</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code<span class="token punctuation">,</span> input<span class="token punctuation">)</span> <span class="token operator">?</span>
                    <span class="token punctuation">[</span><span class="token string">'open/success'</span><span class="token punctuation">,</span> <span class="token string">&quot;Opened&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">:</span>
                    <span class="token punctuation">[</span><span class="token string">'closed/error'</span><span class="token punctuation">,</span> <span class="token string">&quot;ERROR&quot;</span><span class="token punctuation">]</span>

                <span class="token keyword">return</span> <span class="token function">nextState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">{</span>message<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> msg<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token operator">/</span><span class="token operator">/</span> Not long enough<span class="token punctuation">.</span> Keep collecting digits<span class="token punctuation">.</span>
            <span class="token operator">/</span><span class="token operator">/</span> Show masked code<span class="token punctuation">.</span> Repeat state <span class="token keyword">for</span>
            <span class="token operator">/</span><span class="token operator">/</span> setting timeout
            <span class="token keyword">return</span> <span class="token function">repeatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                input<span class="token punctuation">:</span> <span class="token punctuation">{</span>$push<span class="token punctuation">:</span> <span class="token punctuation">[</span>digit<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                message<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token operator">/</span><span class="token operator">/</span> These states timeout on <span class="token function">inactivity</span> <span class="token punctuation">(</span>eventTimeout<span class="token punctuation">)</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'enter#*_#open/locking'</span><span class="token punctuation">,</span>
            <span class="token string">'enter#*_#closed/unlocking'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token function">keepState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eventTimeout</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token operator">/</span><span class="token operator">/</span> these states just timeout
        <span class="token punctuation">[</span><span class="token string">'enter#*_#:state/*_'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token function">keepState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// If we timeout in a sub state, go to the base state</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'genericTimeout#*_#:state/*_'</span><span class="token punctuation">,</span>
            <span class="token string">'eventTimeout#*_#:state/*_'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>args<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token function">nextState</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    initialData<span class="token punctuation">:</span> SafeData <span class="token operator">=</span> <span class="token punctuation">{</span>
        code<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        codeSize<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        timeout<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        input<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    initialState <span class="token operator">=</span> <span class="token string">'open'</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">timeout<span class="token punctuation">:</span> Timeout</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>initialData<span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Safe Interface. casts 'reset'
     */</span>
    <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'reset'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Safe Interface. cast 'lock'
     */</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'lock'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Safe Interface. send button digit
     * @param digit
     */</span>
    <span class="token function">button</span><span class="token punctuation">(</span><span class="token parameter">digit<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>button<span class="token punctuation">:</span> digit<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Here’s the hotel safe’s state diagram. The collection of <code>open(/*)</code> states (and likewise, <code>closed(/*)</code> states) represents a state machine and the rule of thumb is to implement it in a separate machine. Complex states however, make the job easier for simple hierarchies, as shown above.</p> <p><img src="https://github.com/venkatperi/hotelsafe/blob/master/hotel_safe.svg" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/statem/assets/js/app.3c669fc2.js" defer></script><script src="/statem/assets/js/7.f5c78133.js" defer></script><script src="/statem/assets/js/3.6da4c649.js" defer></script>
  </body>
</html>
